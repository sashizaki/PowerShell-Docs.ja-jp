---
ms.date: 06/11/2020
keywords: powershell,コマンドレット
title: WinRM を使用した PowerShell リモート処理のセキュリティに関する考慮事項
description: このドキュメントでは、PowerShell リモート処理を使用する場合のセキュリティ上の問題、推奨事項、およびベスト プラクティスを取り上げています。
ms.openlocfilehash: 48167bd297905883b3d75caf9a07d06e6a9fc467
ms.sourcegitcommit: ba7315a496986451cfc1296b659d73ea2373d3f0
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/10/2020
ms.locfileid: "92501475"
---
# <a name="security-considerations-for-powershell-remoting-using-winrm"></a><span data-ttu-id="7994f-104">WinRM を使用した PowerShell リモート処理のセキュリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="7994f-104">Security Considerations for PowerShell Remoting using WinRM</span></span>

<span data-ttu-id="7994f-105">PowerShell リモート処理は、Windows システムの管理に推奨されている方法です。</span><span class="sxs-lookup"><span data-stu-id="7994f-105">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="7994f-106">Windows Server 2012 R2 では、PowerShell リモート処理が既定で有効になっています。</span><span class="sxs-lookup"><span data-stu-id="7994f-106">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="7994f-107">このドキュメントでは、PowerShell リモート処理を使用する場合のセキュリティ上の問題、推奨事項、およびベスト プラクティスを取り上げています。</span><span class="sxs-lookup"><span data-stu-id="7994f-107">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="7994f-108">PowerShell リモート処理とは</span><span class="sxs-lookup"><span data-stu-id="7994f-108">What is PowerShell Remoting?</span></span>

<span data-ttu-id="7994f-109">PowerShell リモート処理は、[Windows リモート管理 (WinRM)](/windows/win32/winrm/portal) を使用しています。これは、ユーザーがリモート コンピューター上で PowerShell コマンドを実行できるように、Microsoft によって [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) プロトコルが実装されたものです。</span><span class="sxs-lookup"><span data-stu-id="7994f-109">PowerShell Remoting uses [Windows Remote Management (WinRM)](/windows/win32/winrm/portal), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="7994f-110">PowerShell リモート処理の使用方法の詳細については、「[リモート コマンドの実行](running-remote-commands.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7994f-110">You can find more information about using PowerShell Remoting at [Running Remote Commands](running-remote-commands.md).</span></span>

<span data-ttu-id="7994f-111">PowerShell リモート処理は、コマンドレットの **ComputerName** パラメーターを使用してリモート コンピューターでコマンドを実行することとは異なります。この場合は、基盤となるプロトコルとしてリモート プロシージャ コール (RPC) が使用されています。</span><span class="sxs-lookup"><span data-stu-id="7994f-111">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="7994f-112">PowerShell リモート処理の既定の設定</span><span class="sxs-lookup"><span data-stu-id="7994f-112">PowerShell Remoting default settings</span></span>

<span data-ttu-id="7994f-113">PowerShell リモート処理 (および WinRM) は、次のポートをリッスンします。</span><span class="sxs-lookup"><span data-stu-id="7994f-113">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="7994f-114">HTTP: 5985</span><span class="sxs-lookup"><span data-stu-id="7994f-114">HTTP: 5985</span></span>
- <span data-ttu-id="7994f-115">HTTPS: 5986</span><span class="sxs-lookup"><span data-stu-id="7994f-115">HTTPS: 5986</span></span>

<span data-ttu-id="7994f-116">既定では、PowerShell リモート処理で許可されている接続は、Administrators グループのメンバーからのもののみです。</span><span class="sxs-lookup"><span data-stu-id="7994f-116">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span>
<span data-ttu-id="7994f-117">セッションはユーザーのコンテキストで開始されるため、PowerShell リモート処理を介して接続されている間は、個々のユーザーとグループに適用されているオペレーティング システムのアクセス制御がすべて、そのセッションに引き続き適用されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-117">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="7994f-118">プライベート ネットワークの場合、PowerShell リモート処理の既定の Windows ファイアウォール規則はすべての接続を受け入れます。</span><span class="sxs-lookup"><span data-stu-id="7994f-118">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="7994f-119">パブリック ネットワークの場合、既定の Windows ファイアウォール規則で許可されるのは、同じサブネット内からの PowerShell リモート処理接続のみです。</span><span class="sxs-lookup"><span data-stu-id="7994f-119">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="7994f-120">パブリック ネットワーク上のすべての接続に対して PowerShell リモート処理を可能にするには、その規則を明示的に変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7994f-120">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

> [!Warning]
> <span data-ttu-id="7994f-121">パブリック ネットワークのファイアウォール規則は、悪意のある外部接続からコンピューターを保護することを目的としています。</span><span class="sxs-lookup"><span data-stu-id="7994f-121">The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="7994f-122">この規則を削除する際は注意してください。</span><span class="sxs-lookup"><span data-stu-id="7994f-122">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="7994f-123">プロセスの分離</span><span class="sxs-lookup"><span data-stu-id="7994f-123">Process isolation</span></span>

<span data-ttu-id="7994f-124">PowerShell リモート処理によって、コンピューター間の通信に WinRM が使用されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-124">PowerShell Remoting uses WinRM for communication between computers.</span></span> <span data-ttu-id="7994f-125">WinRM は Network Service アカウントでサービスとして実行されており、ユーザー アカウントとして実行される分離プロセスを生成して、PowerShell インスタンスをホストします。</span><span class="sxs-lookup"><span data-stu-id="7994f-125">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="7994f-126">1 ユーザーとして実行されている PowerShell のインスタンスは、別のユーザーとして PowerShell のインスタンスを実行しているプロセスにアクセスすることはできません。</span><span class="sxs-lookup"><span data-stu-id="7994f-126">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="7994f-127">PowerShell リモート処理によって生成されたイベント ログ</span><span class="sxs-lookup"><span data-stu-id="7994f-127">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="7994f-128">FireEye は、PowerShell リモート処理セッションによって生成されたイベント ログやその他のセキュリティ証拠をまとめたものを提供しています。これは、概要をまとめられています。これについては、「[Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)」(PowerShell 攻撃の調査) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7994f-128">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="7994f-129">暗号化とトランスポート プロトコル</span><span class="sxs-lookup"><span data-stu-id="7994f-129">Encryption and transport protocols</span></span>

<span data-ttu-id="7994f-130">PowerShell リモート処理の接続のセキュリティについては、初期認証と進行中の通信という 2 つの観点から考慮することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="7994f-130">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="7994f-131">使用されているトランスポート プロトコル (HTTP または HTTPS) に関係なく、WinRM により、常にすべての PowerShell リモート処理の通信が、初期認証後に暗号化されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-131">Regardless of the transport protocol used (HTTP or HTTPS), WinRM always encrypts all PowerShell remoting communication after initial authentication.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="7994f-132">初期認証</span><span class="sxs-lookup"><span data-stu-id="7994f-132">Initial authentication</span></span>

<span data-ttu-id="7994f-133">認証では、サーバーに対するクライアントの ID と、理想的にはクライアントに対するサーバーを確認します。</span><span class="sxs-lookup"><span data-stu-id="7994f-133">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="7994f-134">クライアントがコンピューター名を使用してドメイン サーバーに接続する場合、既定の認証プロトコルは [Kerberos](/windows/win32/secauthn/microsoft-kerberos) です。</span><span class="sxs-lookup"><span data-stu-id="7994f-134">When a client connects to a domain server using its computer name, the default authentication protocol is [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span></span> <span data-ttu-id="7994f-135">Kerberos では、再利用可能な資格情報を送信しなくても、ユーザー ID とサーバー ID の両方が保証されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-135">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="7994f-136">クライアントが IP アドレスを使用してドメイン サーバーに接続する場合、またはワークグループ サーバーに接続する場合は、Kerberos 認証を使用できません。</span><span class="sxs-lookup"><span data-stu-id="7994f-136">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="7994f-137">その場合は、PowerShell リモート処理は [NTLM 認証プロトコル](/windows/win32/secauthn/microsoft-ntlm)を利用します。</span><span class="sxs-lookup"><span data-stu-id="7994f-137">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](/windows/win32/secauthn/microsoft-ntlm).</span></span> <span data-ttu-id="7994f-138">NTLM 認証プロトコルでは、委任可能な資格情報を送信しなくてもユーザー ID が保証されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-138">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="7994f-139">NTLM プロトコルは、ユーザー ID を証明するために、クライアントとサーバーの両方でユーザーのパスワードからセッション キーを計算することを要求します。パスワード自体は交換しません。</span><span class="sxs-lookup"><span data-stu-id="7994f-139">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="7994f-140">サーバーは、通常ユーザーのパスワードを知らないため、ドメイン コントローラーと通信します。ドメイン コントローラーがユーザーのパスワードを知っていて、サーバー用にセッション キーを計算します。</span><span class="sxs-lookup"><span data-stu-id="7994f-140">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="7994f-141">一方、NTLM プロトコルでは、サーバー ID が保証されません。</span><span class="sxs-lookup"><span data-stu-id="7994f-141">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="7994f-142">ドメインに参加しているコンピューターのコンピューター アカウントにアクセスできる攻撃者は、認証に NTLM を使用するプロトコルと同様にドメイン コントローラーを呼び出して NTLM セッション キーを計算することで、サーバーになりすます場合があります。</span><span class="sxs-lookup"><span data-stu-id="7994f-142">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="7994f-143">NTLM ベースの認証は既定では無効になっていますが、ターゲット サーバーで SSL を構成するか、クライアントで WinRM TrustedHosts 設定を構成することで許可できます。</span><span class="sxs-lookup"><span data-stu-id="7994f-143">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="7994f-144">NTLM ベースの接続時に SSL 証明書を使用してサーバー ID を検証する</span><span class="sxs-lookup"><span data-stu-id="7994f-144">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="7994f-145">NTLM 認証プロトコルではターゲット サーバーの ID を保証できないため (パスワードを認識しているだけのため)、PowerShell リモート処理に SSL を使用するようターゲット サーバーを構成できます。</span><span class="sxs-lookup"><span data-stu-id="7994f-145">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span>
<span data-ttu-id="7994f-146">SSL 証明書をターゲット サーバーに割り当てると (クライアントも信頼している証明機関によって発行されている場合)、ユーザー ID とサーバー ID の両方が保証される NTLM ベースの認証が可能になります。</span><span class="sxs-lookup"><span data-stu-id="7994f-146">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="7994f-147">NTLM ベースのサーバー ID を無視する</span><span class="sxs-lookup"><span data-stu-id="7994f-147">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="7994f-148">SSL 証明書を NTLM 接続用のサーバーに展開できない場合は、そのサーバーを WinRM の **TrustedHosts** 一覧に追加することで ID エラーの発生を抑制できます。</span><span class="sxs-lookup"><span data-stu-id="7994f-148">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="7994f-149">サーバー名を **TrustedHosts** の一覧に追加することは、ホスト自体の信頼性を表明するいずれの形でもないことにご注意ください。NTLM 認証プロトコルでは、実際に接続先となるホストが、意図する接続先であるとは限らないからです。</span><span class="sxs-lookup"><span data-stu-id="7994f-149">Please note that adding a server name to the **TrustedHosts** list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span> <span data-ttu-id="7994f-150">代わりに、TrustedHosts の設定を、サーバーの ID を確認できないことが原因で生成されたエラーを抑制するホストの一覧と考える必要があります。</span><span class="sxs-lookup"><span data-stu-id="7994f-150">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>

### <a name="ongoing-communication"></a><span data-ttu-id="7994f-151">進行中の通信</span><span class="sxs-lookup"><span data-stu-id="7994f-151">Ongoing Communication</span></span>

<span data-ttu-id="7994f-152">初期認証が完了すると、WinRM では、進行中の通信が暗号化されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-152">Once initial authentication is complete, the WinRM encrypts the ongoing communication.</span></span> <span data-ttu-id="7994f-153">HTTPS 経由で接続する場合は、データの転送に使用される暗号化をネゴシエートするために TLS プロトコルが使用されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-153">When connecting over HTTPS, the TLS protocol is used to negotiate the encryption used to transport data.</span></span>
<span data-ttu-id="7994f-154">HTTP 経由で接続する場合、メッセージレベルの暗号化は、使用される初期認証プロトコルによって決定されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-154">When connecting over HTTP, message-level encryption is determined by initial authentication protocol used.</span></span>

- <span data-ttu-id="7994f-155">基本認証では、暗号化は行われません。</span><span class="sxs-lookup"><span data-stu-id="7994f-155">Basic authentication provide no encryption.</span></span>
- <span data-ttu-id="7994f-156">NTLM 認証では、128 ビット キーを使用して RC4 暗号が使用されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-156">NTLM authentication uses an RC4 cipher with a 128-bit key.</span></span>
- <span data-ttu-id="7994f-157">Kerberos 認証の暗号化は、TGS チケットの `etype` によって決定されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-157">Kerberos authentication encryption is determined by the `etype` in the TGS ticket.</span></span> <span data-ttu-id="7994f-158">これは、最新のシステムでの AES-256 です。</span><span class="sxs-lookup"><span data-stu-id="7994f-158">This is AES-256 on modern systems.</span></span>
- <span data-ttu-id="7994f-159">CredSSP 暗号化では、ハンドシェイクでネゴシエートされた TLS 暗号スイートが使用されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-159">CredSSP encryption is uses the TLS cipher suite that was negotiated in the handshake.</span></span>

## <a name="making-the-second-hop"></a><span data-ttu-id="7994f-160">次ホップの実行</span><span class="sxs-lookup"><span data-stu-id="7994f-160">Making the second hop</span></span>

<span data-ttu-id="7994f-161">PowerShell リモート処理では、既定で、認証に Kerberos (使用可能な場合) または NTLM が使用されます。</span><span class="sxs-lookup"><span data-stu-id="7994f-161">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="7994f-162">このどちらのプロトコルも、資格情報を送信することなく、リモート コンピューターに対して認証を行います。</span><span class="sxs-lookup"><span data-stu-id="7994f-162">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span> <span data-ttu-id="7994f-163">これは認証方法としては最も安全ですが、リモート コンピューターにユーザーの資格情報がないため、このリモート コンピューターは、ユーザーに代わって他のコンピューターおよびサービスにアクセスすることはできません。</span><span class="sxs-lookup"><span data-stu-id="7994f-163">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span> <span data-ttu-id="7994f-164">これは "次ホップの問題" と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="7994f-164">This is known as the "second hop problem".</span></span>

<span data-ttu-id="7994f-165">この問題を回避する方法はいくつかあります。</span><span class="sxs-lookup"><span data-stu-id="7994f-165">There are several ways to avoid this problem.</span></span> <span data-ttu-id="7994f-166">これらの方法およびその長所と短所については、「[PowerShell リモート処理での次ホップの実行](PS-remoting-second-hop.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="7994f-166">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>

## <a name="references"></a><span data-ttu-id="7994f-167">References</span><span class="sxs-lookup"><span data-stu-id="7994f-167">References</span></span>

- [<span data-ttu-id="7994f-168">Windows リモート管理 (WinRM)</span><span class="sxs-lookup"><span data-stu-id="7994f-168">Windows Remote Management (WinRM)</span></span>](/windows/win32/winrm/portal)
- [<span data-ttu-id="7994f-169">Web Services for Management (WS-Management)</span><span class="sxs-lookup"><span data-stu-id="7994f-169">Web Services for Management (WS-Management)</span></span>](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf)
- [<span data-ttu-id="7994f-170">2.2.9.1 暗号化されたメッセージ型</span><span class="sxs-lookup"><span data-stu-id="7994f-170">2.2.9.1 Encrypted Message Types</span></span>](/openspecs/windows_protocols/ms-wsmv/58421aa4-861a-4410-831a-c999f094cdb7)
- [<span data-ttu-id="7994f-171">Kerberos</span><span class="sxs-lookup"><span data-stu-id="7994f-171">Kerberos</span></span>](/windows/win32/secauthn/microsoft-kerberos)
- [<span data-ttu-id="7994f-172">NTLM 認証プロトコル</span><span class="sxs-lookup"><span data-stu-id="7994f-172">NTLM authentication protocol</span></span>](/windows/win32/secauthn/microsoft-ntlm)
- [<span data-ttu-id="7994f-173">PowerShell 攻撃の調査</span><span class="sxs-lookup"><span data-stu-id="7994f-173">Investigating PowerShell Attacks</span></span>](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)
